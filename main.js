/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// src/main.ts
var main_exports = {};
__export(main_exports, {
  default: () => AgentKitPlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian5 = require("obsidian");

// src/core/Orchestrator.ts
var import_obsidian = require("obsidian");
var Orchestrator = class {
  constructor(plugin) {
    this._isRunning = false;
    this.agents = [];
    this.plugin = plugin;
  }
  get isRunning() {
    return this._isRunning;
  }
  registerAgent(agent) {
    this.agents.push(agent);
    if (!this.plugin.data.queues[agent.queueName]) {
      this.plugin.data.queues[agent.queueName] = [];
    }
    console.log(`[Orchestrator] å·²æ³¨å†Œ Agent: ${agent.constructor.name} -> ç›‘æ§é˜Ÿåˆ—: ${agent.queueName}`);
  }
  async addToQueue(queueName, item) {
    if (!this.plugin.data.queues[queueName]) {
      this.plugin.data.queues[queueName] = [];
    }
    item.retries = 0;
    this.plugin.data.queues[queueName].push(item);
    await this.plugin.saveData();
  }
  start() {
    if (this._isRunning)
      return;
    this._isRunning = true;
    new import_obsidian.Notice("ğŸš€ OAK å¼•æ“å·²å¯åŠ¨");
    this.loop().catch((err) => console.error("[Orchestrator] Loop error:", err));
  }
  stop() {
    this._isRunning = false;
    new import_obsidian.Notice("ğŸ›‘ OAK å¼•æ“å·²åœæ­¢");
  }
  async loop() {
    if (!this._isRunning)
      return;
    let workDone = false;
    for (const agent of this.agents) {
      if (!this._isRunning)
        break;
      const queueName = agent.queueName;
      const queue = this.plugin.data.queues[queueName];
      if (queue && queue.length > 0) {
        const item = queue[0];
        try {
          const success = await agent.process(item);
          if (success) {
            queue.shift();
            workDone = true;
          } else {
            throw new Error("Agent process returned false.");
          }
        } catch (error) {
          console.error(`[Agent Error] ${agent.constructor.name} å¤„ç†ä»»åŠ¡å¤±è´¥:`, item, error);
          workDone = true;
          const failedItem = queue.shift();
          if (failedItem) {
            failedItem.retries = (failedItem.retries || 0) + 1;
            const maxRetries = this.plugin.data.settings.maxRetries || 3;
            if (failedItem.retries < maxRetries) {
              queue.push(failedItem);
              new import_obsidian.Notice(`ä»»åŠ¡å¤±è´¥ï¼Œå°†åœ¨ç¨åé‡è¯• (${failedItem.retries}/${maxRetries})`);
            } else {
              new import_obsidian.Notice(`ä»»åŠ¡å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå·²è¢«æ”¾å¼ƒã€‚è¯·æ£€æŸ¥æ—¥å¿—ã€‚`);
              console.error(`[Agent Error] ä»»åŠ¡æ°¸ä¹…å¤±è´¥:`, failedItem);
            }
          }
        } finally {
          await this.plugin.saveData();
        }
      }
    }
    const delay = workDone ? 100 : 2e3;
    setTimeout(() => {
      this.loop().catch((err) => console.error("[Orchestrator] Loop error in timeout:", err));
    }, delay);
  }
};

// src/core/LLMProvider.ts
var import_obsidian2 = require("obsidian");
var LLMProvider = class {
  constructor(getSettings) {
    this.getSettings = getSettings;
  }
  async chat(prompt) {
    const settings = this.getSettings();
    const provider = settings.llmProvider;
    try {
      if (provider === "openai") {
        return await this.callOpenAI(prompt);
      } else if (provider === "google") {
        return await this.callGoogle(prompt);
      } else {
        throw new Error(`æœªçŸ¥çš„æä¾›å•†: ${provider}`);
      }
    } catch (error) {
      const msg = error instanceof Error ? error.message : String(error);
      console.error("[LLM Error]", error);
      new import_obsidian2.Notice(`AI è°ƒç”¨å¤±è´¥: ${msg}`);
      return "";
    }
  }
  async callOpenAI(prompt) {
    const settings = this.getSettings();
    if (!settings.openaiApiKey)
      throw new Error("OpenAI API Key æœªé…ç½®");
    const url = `${settings.openaiBaseUrl.replace(/\/$/, "")}/chat/completions`;
    const response = await (0, import_obsidian2.requestUrl)({
      url,
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${settings.openaiApiKey}`
      },
      body: JSON.stringify({
        model: settings.openaiModel,
        messages: [{ role: "user", content: prompt }],
        temperature: 0.7
      })
    });
    if (response.status >= 400) {
      throw new Error(`OpenAI API Error: ${response.status}`);
    }
    return response.json.choices[0].message.content.trim();
  }
  async callGoogle(prompt) {
    const settings = this.getSettings();
    if (!settings.googleApiKey)
      throw new Error("Google API Key æœªé…ç½®");
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${settings.googleModel}:generateContent?key=${settings.googleApiKey}`;
    const response = await (0, import_obsidian2.requestUrl)({
      url,
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });
    if (response.status >= 400) {
      throw new Error(`Google API Error: ${response.status}`);
    }
    if (response.json.candidates && response.json.candidates.length > 0) {
      return response.json.candidates[0].content.parts[0].text.trim();
    }
    return "";
  }
};

// src/core/BaseAgent.ts
var BaseAgent = class {
  // --- ä¿®æ”¹ ---: ä½¿ç”¨æ–°çš„æ¥å£ç±»å‹
  constructor(plugin, llm) {
    this.plugin = plugin;
    this.llm = llm;
  }
  // è®¿é—®å™¨ä¿æŒä¸å˜ï¼Œä½†ç°åœ¨ç±»å‹æ›´å®‰å…¨
  get settings() {
    return this.plugin.data.settings;
  }
  get app() {
    return this.plugin.app;
  }
};

// src/agents/GeneratorAgent.ts
var _GeneratorAgent = class extends BaseAgent {
  get queueName() {
    return _GeneratorAgent.QUEUE_NAME;
  }
  async process(item) {
    console.debug(`[GeneratorAgent] æ­£åœ¨å¤„ç†æ¦‚å¿µ: ${item.concept}`);
    const prompt = this.settings.prompt_generator.replace("{concept}", item.concept);
    const content = await this.llm.chat(prompt);
    if (!content || content.trim().length === 0) {
      console.error("[GeneratorAgent] LLM è¿”å›å†…å®¹ä¸ºç©ºã€‚");
      return false;
    }
    const outputDir = this.settings.output_dir;
    const fileName = `${item.concept.replace(/[\\/:"*?<>|]/g, "_")}.md`;
    const filePath = `${outputDir}/${fileName}`;
    const fileExists = await this.app.vault.adapter.exists(filePath);
    if (fileExists) {
      console.warn(`[GeneratorAgent] æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º: ${filePath}`);
      return true;
    }
    await this.app.vault.create(filePath, content);
    console.debug(`[GeneratorAgent] å·²æˆåŠŸåˆ›å»ºæ–‡ä»¶: ${filePath}`);
    return true;
  }
};
var GeneratorAgent = _GeneratorAgent;
GeneratorAgent.QUEUE_NAME = "generation_queue";

// src/settings.ts
var import_obsidian3 = require("obsidian");
var OAKSettingTab = class extends import_obsidian3.PluginSettingTab {
  constructor(app, plugin) {
    super(app, plugin);
    this.plugin = plugin;
  }
  display() {
    const { containerEl } = this;
    containerEl.empty();
    new import_obsidian3.Setting(containerEl).setName("General").setHeading();
    new import_obsidian3.Setting(containerEl).setName("AI æ¨¡å‹æä¾›å•†").addDropdown((d) => d.addOption("openai", "OpenAI").addOption("google", "Google").setValue(this.plugin.data.settings.llmProvider).onChange(async (v) => {
      this.plugin.data.settings.llmProvider = v;
      await this.plugin.saveData();
      this.display();
    }));
    if (this.plugin.data.settings.llmProvider === "openai") {
      new import_obsidian3.Setting(containerEl).setName("OpenAI settings").setHeading();
      new import_obsidian3.Setting(containerEl).setName("API Key").addText((t) => t.setValue(this.plugin.data.settings.openaiApiKey).onChange(async (v) => {
        this.plugin.data.settings.openaiApiKey = v;
        await this.plugin.saveData();
      }));
      new import_obsidian3.Setting(containerEl).setName("Base URL").addText((t) => t.setValue(this.plugin.data.settings.openaiBaseUrl).onChange(async (v) => {
        this.plugin.data.settings.openaiBaseUrl = v;
        await this.plugin.saveData();
      }));
      new import_obsidian3.Setting(containerEl).setName("æ¨¡å‹åç§°").addText((t) => t.setValue(this.plugin.data.settings.openaiModel).onChange(async (v) => {
        this.plugin.data.settings.openaiModel = v;
        await this.plugin.saveData();
      }));
    }
    if (this.plugin.data.settings.llmProvider === "google") {
      new import_obsidian3.Setting(containerEl).setName("Google Gemini settings").setHeading();
      new import_obsidian3.Setting(containerEl).setName("API Key").addText((t) => t.setValue(this.plugin.data.settings.googleApiKey).onChange(async (v) => {
        this.plugin.data.settings.googleApiKey = v;
        await this.plugin.saveData();
      }));
      new import_obsidian3.Setting(containerEl).setName("æ¨¡å‹åç§°").addText((t) => t.setValue(this.plugin.data.settings.googleModel).onChange(async (v) => {
        this.plugin.data.settings.googleModel = v;
        await this.plugin.saveData();
      }));
    }
    new import_obsidian3.Setting(containerEl).setName("Engine").setHeading();
    new import_obsidian3.Setting(containerEl).setName("è¾“å‡ºæ–‡ä»¶å¤¹").addText((t) => t.setValue(this.plugin.data.settings.output_dir).onChange(async (v) => {
      this.plugin.data.settings.output_dir = v;
      await this.plugin.saveData();
    }));
    new import_obsidian3.Setting(containerEl).setName("ç”Ÿæˆ Prompt æ¨¡æ¿").addTextArea((t) => {
      t.setValue(this.plugin.data.settings.prompt_generator).onChange(async (v) => {
        this.plugin.data.settings.prompt_generator = v;
        await this.plugin.saveData();
      });
      t.inputEl.rows = 5;
    });
  }
};

// src/InputModal.ts
var import_obsidian4 = require("obsidian");
var InputModal = class extends import_obsidian4.Modal {
  constructor(app, onSubmit) {
    super(app);
    this.onSubmit = onSubmit;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.createEl("h2", { text: "ğŸŒ± æ’­ç§æ–°æ¦‚å¿µ" });
    let inputElement;
    new import_obsidian4.Setting(contentEl).setName("è¾“å…¥æ¦‚å¿µåç§°").setDesc("è¾“å…¥ä½ æƒ³ç”Ÿæˆçš„çŸ¥è¯†ç‚¹ï¼Œä¾‹å¦‚ï¼š'ç¬¬ä¸€æ€§åŸç†'").addText((text) => {
      inputElement = text.inputEl;
      text.onChange((value) => {
        this.result = value;
      });
      text.inputEl.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          this.submit();
        }
      });
    });
    new import_obsidian4.Setting(contentEl).addButton((btn) => btn.setButtonText("æ·»åŠ åˆ°é˜Ÿåˆ—").setCta().onClick(() => {
      this.submit();
    }));
    setTimeout(() => inputElement == null ? void 0 : inputElement.focus(), 0);
  }
  submit() {
    if (this.result && this.result.trim().length > 0) {
      this.close();
      this.onSubmit(this.result.trim());
    } else {
      this.close();
    }
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
};

// src/main.ts
var DEFAULT_DATA = {
  queues: {
    "generation_queue": []
  },
  settings: {
    llmProvider: "openai",
    openaiApiKey: "",
    openaiBaseUrl: "https://api.openai.com/v1",
    openaiModel: "gpt-3.5-turbo",
    googleApiKey: "",
    googleModel: "gemini-1.5-flash",
    maxRetries: 3,
    prompt_generator: "è¯·è¯¦ç»†è§£é‡Šæ¦‚å¿µ: {concept}ï¼ŒåŒ…å«å®šä¹‰ã€åŸç†å’Œåº”ç”¨ã€‚",
    output_dir: "KnowledgeGraph"
  }
};
var AgentKitPlugin = class extends import_obsidian5.Plugin {
  async onload() {
    await this.loadData();
    if (!await this.app.vault.adapter.exists(this.data.settings.output_dir)) {
      await this.app.vault.createFolder(this.data.settings.output_dir);
    }
    this.addSettingTab(new OAKSettingTab(this.app, this));
    this.llm = new LLMProvider(() => this.data.settings);
    this.orchestrator = new Orchestrator(this);
    this.orchestrator.registerAgent(new GeneratorAgent(this, this.llm));
    this.addCommand({
      id: "add-custom-concept",
      name: "æ·»åŠ æ–°æ¦‚å¿µåˆ°ç”Ÿæˆé˜Ÿåˆ—",
      callback: () => {
        new InputModal(this.app, (concept) => {
          this.orchestrator.addToQueue(GeneratorAgent.QUEUE_NAME, { concept }).then(() => {
            new import_obsidian5.Notice(`å·²å°† '${concept}' åŠ å…¥é˜Ÿåˆ—ã€‚`);
          }).catch((err) => {
            console.error("Failed to add to queue:", err);
            new import_obsidian5.Notice("åŠ å…¥é˜Ÿåˆ—å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
          });
        }).open();
      }
    });
    this.addCommand({
      id: "toggle-oak",
      name: "å¯åŠ¨/åœæ­¢ OAK å¼•æ“",
      callback: () => {
        if (this.orchestrator.isRunning) {
          this.orchestrator.stop();
        } else {
          this.orchestrator.start();
        }
      }
    });
    this.addRibbonIcon("bot", "OAK: æ·»åŠ æ–°æ¦‚å¿µ", () => {
      new InputModal(this.app, (concept) => {
        this.orchestrator.addToQueue(GeneratorAgent.QUEUE_NAME, { concept }).then(() => {
          if (!this.orchestrator.isRunning) {
            this.orchestrator.start();
          }
        }).catch(console.error);
      }).open();
    });
    console.log("OAK Agent Kit loaded.");
  }
  onunload() {
    console.log("OAK Agent Kit unloaded.");
  }
  async loadData() {
    const loaded = await super.loadData();
    this.data = {
      ...DEFAULT_DATA,
      ...loaded,
      settings: {
        ...DEFAULT_DATA.settings,
        ...(loaded == null ? void 0 : loaded.settings) || {}
      },
      queues: {
        ...DEFAULT_DATA.queues,
        ...(loaded == null ? void 0 : loaded.queues) || {}
      }
    };
  }
  async saveData() {
    await super.saveData(this.data);
  }
};
